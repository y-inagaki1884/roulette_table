<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿˜å¹´ä¼šã‚¢ãƒ—ãƒª</title>
    <style>
        /* CSSã¯å…±é€šã§ã™ãŒã€ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§ã¯ç·¨é›†ã‚¨ãƒªã‚¢é–¢é€£ã®CSSã¯ä¸è¦ã§ã™ */
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f7f6;
            color: #333;
            padding: 0 10px;
        }

        /* --- æŠ½é¸çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦åˆ†é›¢ï¼‰ --- */
        #mainResultContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            background-color: #f4f7f6;
            padding: 10px 0;

        }

        #mainResultContainer .container {
            padding: 10px 20px;
            max-width: 800px;
            width: 95%;
            margin: 0 auto;
            box-shadow: none;
        }

        #mainResult {
            font-size: 1em;
            font-weight: bold;
            color: #5cb85c;
            margin: 0 auto;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            background-color: #ffffff;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚³ãƒ³ãƒ†ãƒŠ --- */
        #mainContentWrapper {
            margin-top: 110px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #mainContentWrapper .container {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 95%;
            max-width: 800px;
            text-align: center;
            margin-top: 20px;
        }

        h1 {
            color: #d9534f;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* --- å‡ºå¸­è€…ãƒªã‚¹ãƒˆï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ --- */
        #attendeeListContainer {
            margin-top: 20px;
            text-align: center;
        }

        #attendeeTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.8em;
        }

        #attendeeTable th,
        #attendeeTable td {
            border: 1px solid #ddd;
            padding: 8px;
            vertical-align: middle;
        }

        #attendeeTable th {
            background-color: #eee;
        }

        /* æŠ½é¸ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .draw-button {
            background-color: #4CAF50;
            /* Green */
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .draw-button:hover:not(:disabled) {
            background-color: #45a049;
        }

        .draw-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .seat-result {
            font-weight: bold;
            color: #007bff;
            /* Blue */
        }

        /* è¨­å®šãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ */
        .settings-link {
            display: block;
            margin-top: 30px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="mainResultContainer">
        <div class="container">
            
            <div id="mainResult">è¨­å®šãƒšãƒ¼ã‚¸ã§ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>
        </div>
    </div>

    <div id="mainContentWrapper">
        <div class="container">
            <div id="attendeeListContainer">
                <h2>ğŸ» å¿˜å¹´ä¼šã‚¢ãƒ—ãƒª ğŸ¯</h2>
                <table id="attendeeTable">
                    <thead>
                        <tr>
                            <th>éƒ¨ç½²</th>
                            <th>æ°å</th>
                            <th>ç¾åœ¨ã®å¸­é †</th>
                            <th>æŠ½é¸å®Ÿè¡Œ</th>
                        </tr>
                    </thead>
                    <tbody id="attendeeTableBody">
                    </tbody>
                </table>
            </div>

            <div style="margin-top: 30px;">
                <a href="settings.html" class="settings-link" style="margin-bottom: 10px;">
                    ğŸ“  (è¨­å®šãƒšãƒ¼ã‚¸ã¸)
                </a>
                <a href="bingo.html" class="settings-link" style="background-color: #f39c12;">
                    ğŸ‰  (ãƒ“ãƒ³ã‚´ãƒšãƒ¼ã‚¸ã¸)
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- JavaScript: å‹•ä½œéƒ¨åˆ† ---
        // ãƒ‡ãƒ¼ã‚¿ã¯LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚€

        let attendees = [];
        let availableSeats = [];
        let totalSeats = 0;
        let isDrawing = false;

        const resultDisplay = document.getElementById('mainResult');


        // --- 2. ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã¨å¸­æ•°ã®æ±ºå®š ---
        function loadAttendees() {
            const storedData = localStorage.getItem('attendeeDataCSV');
            if (!storedData) {
                resultDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è¨­å®šãƒšãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                return;
            }

            const lines = storedData.split('\n').filter(line => line.trim() !== '');

            attendees = [];
            totalSeats = 0;
            const usedFixedSeats = new Set();

            lines.forEach((line, index) => {
                const parts = line.split(',').map(p => p.trim());

                let seat = parts[2] ? parseInt(parts[2], 10) : null;
                if (seat !== null && isNaN(seat)) seat = null;

                if (seat) {
                    if (seat > totalSeats) {
                        totalSeats = seat;
                    }
                    usedFixedSeats.add(seat);
                }

                attendees.push({
                    id: index,
                    department: parts[0] || 'ä¸æ˜',
                    name: parts[1] || `åç„¡ã—${index + 1}`,
                    fixedSeat: seat,
                    seat: null,
                    drawn: false,
                    isFixed: !!seat
                });
            });

            if (attendees.length > totalSeats) {
                totalSeats = attendees.length;
            }

            const allSeats = Array.from({ length: totalSeats }, (_, i) => i + 1);
            availableSeats = allSeats.filter(seat => !usedFixedSeats.has(seat));

            // éƒ¨ç½²åã§ã‚½ãƒ¼ãƒˆ
            attendees.sort((a, b) => {
                const deptCompare = a.department.localeCompare(b.department, 'ja', { sensitivity: 'base' });
                if (deptCompare !== 0) {
                    return deptCompare;
                } else {
                    return a.name.localeCompare(b.name, 'ja', { sensitivity: 'base' });
                }
            });

            renderTable();
            resultDisplay.textContent = 'æŠ½é¸ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚';
        }


        // --- ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡¨ç¤ºã¨æŠ½é¸ãƒœã‚¿ãƒ³ã®é…ç½® ---
        function renderTable() {
            const tbody = document.getElementById('attendeeTableBody');
            tbody.innerHTML = '';

            if (attendees.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 4;
                cell.textContent = 'ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šãƒšãƒ¼ã‚¸ã§ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚';
                return;
            }

            attendees.forEach(person => {
                const row = tbody.insertRow();

                row.insertCell().textContent = person.department;
                row.insertCell().textContent = person.name;

                const seatCell = row.insertCell();
                if (person.drawn && person.seat !== null) {
                    seatCell.innerHTML = `<span class="seat-result">${person.seat}ç•ª</span>`;
                } else {
                    seatCell.textContent = 'æœªå®š';
                }

                const buttonCell = row.insertCell();
                const button = document.createElement('button');
                button.className = 'draw-button';
                button.textContent = person.isFixed ? 'ç¢ºèªã™ã‚‹' : 'æŠ½é¸ã™ã‚‹';
                button.disabled = person.drawn;
                button.onclick = () => startDraw(person.id);
                button.id = `drawBtn-${person.id}`;
                buttonCell.appendChild(button);
            });
        }


        // --- æŠ½é¸ãƒ­ã‚¸ãƒƒã‚¯ ---
        function startDraw(personId) {
            if (isDrawing) return;

            const person = attendees.find(p => p.id === personId);
            if (!person || person.drawn) return;

            isDrawing = true;
            document.getElementById(`drawBtn-${personId}`).disabled = true;

            let drawnNumber;

            if (person.isFixed) {
                drawnNumber = person.fixedSeat;
            } else {
                if (availableSeats.length === 0) {
                    resultDisplay.textContent = 'ğŸ‰ æŠ½é¸çµ‚äº†ï¼ç©ºå¸­ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                    isDrawing = false;
                    renderTable();
                    return;
                }

                const randomIndex = Math.floor(Math.random() * availableSeats.length);
                drawnNumber = availableSeats[randomIndex];

                availableSeats.splice(randomIndex, 1);
            }

            displayResult(drawnNumber, personId);
        }

        // --- æŠ½é¸çµæœã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿æ›´æ–° ---
        function displayResult(number, personId) {
            let count = 0;
            const person = attendees.find(p => p.id === personId);

            document.querySelectorAll('.draw-button').forEach(btn => btn.disabled = true);

            const interval = setInterval(() => {
                if (count < 15) {
                    const dummyNumber = Math.floor(Math.random() * totalSeats) + 1;
                    resultDisplay.textContent = `${person.isFixed ? 'ç¢ºèªä¸­' : 'æŠ½é¸ä¸­'}... ${dummyNumber}ç•ª`;
                    count++;
                } else {
                    clearInterval(interval);

                    resultDisplay.textContent = `${person.name} ã•ã‚“ã®å¸­ã¯ ${number}ç•ª ã«æ±ºå®šï¼`;

                    person.seat = number;
                    person.drawn = true;

                    renderTable();

                    document.querySelectorAll('.draw-button').forEach(btn => {
                        const id = parseInt(btn.id.replace('drawBtn-', ''), 10);
                        if (!attendees.find(p => p.id === id).drawn) {
                            btn.disabled = false;
                        }
                    });

                    isDrawing = false;

                    if (attendees.every(a => a.drawn)) {
                        resultDisplay.textContent = 'ğŸ‰ å…¨å“¡åˆ†ã®å¸­ãŒæ±ºã¾ã‚Šã¾ã—ãŸï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
                    }
                }
            }, 80);
        }

        // --- åˆæœŸå®Ÿè¡Œ ---
        window.onload = function () {
            loadAttendees();
        };
    </script>

</body>

</html>
